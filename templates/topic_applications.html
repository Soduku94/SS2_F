{% extends "base.html" %}
{% block title %}Đơn đăng ký: {{ topic.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    {# --- Tiêu đề trang và tên đề tài --- #}
    <h2>Đơn Đăng ký cho Đề tài:</h2>
    <h3 class="text-primary mb-4">{{ topic.title }}</h3>

    {# === Phần Tabs === #}
    <ul class="nav nav-tabs mb-3" id="applicationStatusTabs" role="tablist">
        <li class="nav-item" role="presentation">
            {# Nút tab Chờ duyệt - active mặc định #}
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-tab-pane" type="button" role="tab" aria-controls="pending-tab-pane" aria-selected="true">
                Chờ duyệt <span class="badge bg-secondary">{{ pending_apps|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
             {# Nút tab Đã duyệt #}
            <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved-tab-pane" type="button" role="tab" aria-controls="approved-tab-pane" aria-selected="false">
                Đã duyệt <span class="badge bg-success">{{ approved_apps|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
             {# Nút tab Đã từ chối #}
            <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected-tab-pane" type="button" role="tab" aria-controls="rejected-tab-pane" aria-selected="false">
                Đã từ chối <span class="badge bg-danger">{{ rejected_apps|length }}</span> {# Giả sử có rejected_apps #}
            </button>
        </li>
    </ul>
    {# === Kết thúc Tabs === #}

    {# === Nội dung các Tab (Tab Content) === #}
    <div class="tab-content" id="applicationStatusTabsContent">

        {# --- Nội dung Tab Chờ duyệt --- #}
        <div class="tab-pane fade show active" id="pending-tab-pane" role="tabpanel" aria-labelledby="pending-tab" tabindex="0">
            <h4>Danh sách chờ duyệt</h4>
            {% if pending_apps %}
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Sinh viên</th>
                                <th>MSSV</th>
                                <th>Lớp</th>
                                <th>Ngày ĐK</th>
                                <th>Lời nhắn</th> {# Ví dụ thêm cột lời nhắn #}
                                <th>Hành động</th> {# Cột Duyệt/Từ chối #}
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in pending_apps %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ student.full_name }}</td>
                                <td>{{ student.student_id }}</td> {# Sửa tên trường nếu cần #}
                                <td>{{ student.class_name }}</td> {# Sửa tên trường nếu cần #}
                                <td>{{ app.application_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ app.message | truncate(50) if app.message else '' }}</td> {# Ví dụ #}
                                <td>
                                    {# Form Duyệt - Nhớ thêm CSRF Token #}
                                    <form action="{{ url_for('approve_application', application_id=app.id) }}" method="POST" style="display: inline-block; margin-bottom: 5px;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-success btn-sm w-100">Duyệt</button>
                                    </form>
                                    {# Form Từ chối - Nhớ thêm CSRF Token #}
                                    <form action="{{ url_for('reject_application', application_id=app.id) }}" method="POST" style="display: inline-block;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-danger btn-sm w-100">Từ chối</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Không có đơn đăng ký nào đang chờ duyệt.</p>
            {% endif %}
        </div>
        {# --- Kết thúc Tab Chờ duyệt --- #}

        {# --- Nội dung Tab Đã duyệt --- #}
        <div class="tab-pane fade" id="approved-tab-pane" role="tabpanel" aria-labelledby="approved-tab" tabindex="0">
            <h4>Danh sách đã duyệt</h4>
             {% if approved_apps %}
                <div class="table-responsive">
                    <table class="table table-hover table-bordered table-striped table-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Sinh viên</th>
                                <th>MSSV</th>
                                <th>Lớp</th>
                                <th>Ngày ĐK</th>
                                <th>Ngày duyệt</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in approved_apps %}
                             <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ student.full_name }}</td>
                                <td>{{ student.student_id }}</td>
                                <td>{{ student.class_name }}</td>
                                <td>{{ app.application_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ app.processed_date.strftime('%d/%m/%Y %H:%M') if app.processed_date else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
             {% else %}
                <p>Chưa có đơn đăng ký nào được duyệt.</p>
             {% endif %}
        </div>
        {# --- Kết thúc Tab Đã duyệt --- #}

        {# --- Nội dung Tab Đã từ chối --- #}
        <div class="tab-pane fade" id="rejected-tab-pane" role="tabpanel" aria-labelledby="rejected-tab" tabindex="0">
             <h4>Danh sách đã từ chối</h4>
             {% if rejected_apps %} {# Giả sử có rejected_apps #}
                <div class="table-responsive">
                    <table class="table table-hover table-bordered table-striped table-sm">
                       <thead>
                            <tr>
                                <th>#</th>
                                <th>Sinh viên</th>
                                <th>MSSV</th>
                                <th>Lớp</th>
                                <th>Ngày ĐK</th>
                                <th>Ngày từ chối</th>
                                {# Thêm lý do nếu có #}
                            </tr>
                        </thead>
                         <tbody>
                            {% for app in rejected_apps %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ student.full_name }}</td>
                                <td>{{ student.student_id }}</td>
                                <td>{{ student.class_name }}</td>
                                <td>{{ app.application_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ app.processed_date.strftime('%d/%m/%Y %H:%M') if app.processed_date else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
             {% else %}
                <p>Không có đơn đăng ký nào bị từ chối.</p>
             {% endif %}
        </div>
        {# --- Kết thúc Tab Đã từ chối --- #}

    </div>
    {# === Kết thúc Tab Content === #}

</div>
{% endblock %}